apiVersion: v1
kind: ConfigMap
metadata:
  name: gunicorn-config-cm
data:
  config.py: |
    # IMPORTANT: This is the monkey-patching code.
    # It MUST run before any other modules are imported.
    import gevent.monkey
    gevent.monkey.patch_all()

    import os

    # Attempt to patch the database driver as well
    try:
        import psycopg2cffi.compat
        psycopg2cffi.compat.register()
        print("Gunicorn Config: psycopg2cffi registered for gevent.")
    except ImportError:
        print("Gunicorn Config: WARNING: psycopg2cffi not found, database calls might still block!")
    
    # Use the WEB_THREADS env var from the deployment
    threads = int(os.environ.get('WEB_THREADS', '1'))
